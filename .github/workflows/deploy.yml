name: CI/CD

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      deploy_backend:
        description: 'Deploy backend (Cloud Run)'
        type: boolean
        default: true
      deploy_web:
        description: 'Deploy web (Firebase Hosting)'
        type: boolean
        default: true
      run_e2e:
        description: 'Run e2e tests'
        type: boolean
        default: true

env:
  PROJECT_ID: foodlogr-app
  REGION: us-central1
  BACKEND_SERVICE_NAME: foodlogr-mcp

jobs:
  # Detect which parts of the codebase changed
  changes:
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      web: ${{ steps.filter.outputs.web }}
      e2e: ${{ steps.filter.outputs.e2e }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'backend/**'
            web:
              - 'web/**'
            e2e:
              - 'e2e/**'

  # Run backend tests (unit + integration)
  test-backend:
    needs: changes
    if: needs.changes.outputs.backend == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt

      - name: Run unit tests
        run: |
          cd backend
          pytest tests/core/ -v --tb=short

      - name: Run shell tests (auth functions)
        run: |
          cd backend
          pytest tests/shell/test_auth.py -v --tb=short

      - name: Run API integration tests
        run: |
          cd backend
          pytest tests/shell/test_api.py -v --tb=short

  # Run web build check
  test-web:
    needs: changes
    if: needs.changes.outputs.web == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: web/package-lock.json

      - name: Install dependencies
        run: |
          cd web
          npm ci

      - name: Type check and build
        run: |
          cd web
          npm run build

  # Deploy backend (Cloud Run) - only on main branch
  deploy-backend:
    needs: [changes, test-backend]
    if: |
      github.ref == 'refs/heads/main' &&
      github.event_name != 'pull_request' &&
      (needs.test-backend.result == 'success' || needs.test-backend.result == 'skipped') &&
      (needs.changes.outputs.backend == 'true' || (github.event_name == 'workflow_dispatch' && inputs.deploy_backend))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy to Cloud Run
        run: |
          cd backend
          gcloud run deploy ${{ env.BACKEND_SERVICE_NAME }} \
            --source . \
            --region ${{ env.REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --port 8080 \
            --memory 512Mi \
            --set-env-vars "FIRESTORE_DATABASE=foodlogr,BASE_URL=https://mcp.foodlogr.app"

      - name: Verify deployment
        run: |
          SERVICE_URL=$(gcloud run services describe ${{ env.BACKEND_SERVICE_NAME }} \
            --region ${{ env.REGION }} \
            --format='value(status.url)')
          echo "Service URL: $SERVICE_URL"

          # Test health endpoint
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$SERVICE_URL/health")
          echo "Health check status: $HTTP_STATUS"

          if [ "$HTTP_STATUS" = "200" ]; then
            echo "Backend deployment verified successfully!"
          else
            echo "Backend deployment verification failed!"
            exit 1
          fi

  # Deploy web (Firebase Hosting) - only on main branch
  deploy-web:
    needs: [changes, test-web]
    if: |
      github.ref == 'refs/heads/main' &&
      github.event_name != 'pull_request' &&
      (needs.test-web.result == 'success' || needs.test-web.result == 'skipped') &&
      (needs.changes.outputs.web == 'true' || (github.event_name == 'workflow_dispatch' && inputs.deploy_web))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: web/package-lock.json

      - name: Install and Build
        run: |
          cd web
          npm ci
          npm run build

      - uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_FOODLOGR_APP }}
          channelId: live
          projectId: foodlogr-app
          entryPoint: ./web

  # Run e2e tests after deployment (or on demand)
  e2e-tests:
    needs: [deploy-backend, deploy-web]
    if: |
      always() &&
      github.ref == 'refs/heads/main' &&
      github.event_name != 'pull_request' &&
      (needs.deploy-backend.result == 'success' || needs.deploy-backend.result == 'skipped') &&
      (needs.deploy-web.result == 'success' || needs.deploy-web.result == 'skipped') &&
      (github.event_name == 'workflow_dispatch' && inputs.run_e2e || github.event_name == 'push')
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: e2e/package-lock.json

      - name: Install e2e dependencies
        run: |
          cd e2e
          npm ci

      - name: Install Playwright browsers
        run: |
          cd e2e
          npx playwright install --with-deps chromium

      - name: Run e2e tests
        run: |
          cd e2e
          npm test
        env:
          BASE_URL: https://foodlogr.app
          API_URL: https://mcp.foodlogr.app

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: e2e/playwright-report/
          retention-days: 7

  # PR status check - ensures all tests pass before merge
  pr-status:
    needs: [test-backend, test-web]
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Check test results
        run: |
          echo "All tests passed! PR is ready for review."
